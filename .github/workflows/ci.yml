name: Java CI with Coverage + Semgrep

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  build-test-scan:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Setup JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Build + run tests + coverage
      - name: Build with Maven
        run: mvn clean verify

      # 4. Upload JaCoCo coverage report
      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        with:
          name: jacoco-report
          path: target/site/jacoco/

      # 5. Run Semgrep scan
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: .semgrep.yml

      # 6. Enforce 70% Security Pass threshold
      - name: Enforce Semgrep threshold
        run: |
          # Count total rules applied and total findings
          total=$(semgrep --config .semgrep.yml src/main/java --json | jq '.results | length')
          files=$(ls src/main/java/**/*.java | wc -l)

          if [ "$files" -eq 0 ]; then
            echo "⚠️ No source files found."
            exit 1
          fi

          # Security Pass % = files with no findings / total files * 100
          clean_files=$((files - total))
          percent=$((100 * clean_files / files))

          echo "🔎 Semgrep results: $total issues in $files files"
          echo "✅ Security Pass %: $percent%"

          if [ "$percent" -lt 70 ]; then
            echo "❌ Security Pass below 70%. Failing build."
            exit 1
          else
            echo "✅ Security Pass >= 70%. Build passed."
          fi
